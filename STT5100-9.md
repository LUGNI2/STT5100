STT5100 \#9 - Regression Poisson
================
Arthur Charpentier

``` r
base = read.table("http://freakonometrics.free.fr/baseaffairs.txt",header=TRUE)
str(base)
```

    ## 'data.frame':    563 obs. of  9 variables:
    ##  $ SEX         : int  1 0 0 1 1 0 0 1 0 1 ...
    ##  $ AGE         : num  37 27 32 57 22 32 22 57 32 22 ...
    ##  $ YEARMARRIAGE: num  10 4 15 15 0.75 1.5 0.75 15 15 1.5 ...
    ##  $ CHILDREN    : int  0 0 1 1 0 0 0 1 1 0 ...
    ##  $ RELIGIOUS   : int  3 4 1 5 2 2 2 2 4 4 ...
    ##  $ EDUCATION   : int  18 14 12 18 17 17 12 14 16 14 ...
    ##  $ OCCUPATION  : int  7 6 1 6 6 5 1 4 1 4 ...
    ##  $ SATISFACTION: int  4 4 4 5 3 5 3 4 2 5 ...
    ##  $ Y           : int  0 0 0 0 0 0 0 0 0 0 ...

``` r
table(base$Y)
```

    ## 
    ##   0   1   2   3   4   5   6   7   8  10 
    ## 451  34  17  19  12  11  11   5   2   1

``` r
df=data.frame(y=base$Y,
              religion=as.factor(base$RELIGIOUS),
              occupation=as.factor(base$OCCUPATION),
              expo = 1)

(E=xtabs((y>=0)~religion+occupation,data=df))
```

    ##         occupation
    ## religion  1  2  3  4  5  6  7
    ##        1  4  1  8  4 16  9  0
    ##        2 23  3 11 17 56 36  6
    ##        3 29  1 10 12 39 25  2
    ##        4 38  7 12 21 59 44  2
    ##        5 13  1  3 10 19 19  3

``` r
(N=xtabs(y~religion+occupation,data=df))
```

    ##         occupation
    ## religion  1  2  3  4  5  6  7
    ##        1  4  1 13  3 13  7  0
    ##        2  1  1 13 10 25 43 10
    ##        3 15  0 12 11 34 35  1
    ##        4 24  1  3 15 11  9 10
    ##        5  6  0  0  6 11  7  0

``` r
sum(N)/sum(E)
```

    ## [1] 0.6305506

``` r
A=rep(1,length(levels(df$religion)))
B=rep(1,length(levels(df$occupation)))*sum(N)/sum(E)
A
```

    ## [1] 1 1 1 1 1

``` r
B
```

    ## [1] 0.6305506 0.6305506 0.6305506 0.6305506 0.6305506 0.6305506 0.6305506

``` r
E * A%*%t(B)
```

    ##         occupation
    ## religion          1          2          3          4          5          6
    ##        1  2.5222025  0.6305506  5.0444050  2.5222025 10.0888099  5.6749556
    ##        2 14.5026643  1.8916519  6.9360568 10.7193606 35.3108348 22.6998224
    ##        3 18.2859680  0.6305506  6.3055062  7.5666075 24.5914742 15.7637655
    ##        4 23.9609236  4.4138544  7.5666075 13.2415631 37.2024867 27.7442274
    ##        5  8.1971581  0.6305506  1.8916519  6.3055062 11.9804618 11.9804618
    ##         occupation
    ## religion          7
    ##        1  0.0000000
    ##        2  3.7833037
    ##        3  1.2611012
    ##        4  1.2611012
    ##        5  1.8916519

``` r
sum(B*E[1,])
```

    ## [1] 26.48313

``` r
sum(B*E[2,])
```

    ## [1] 95.84369

``` r
apply(t(B*t(E)),1,sum)
```

    ##         1         2         3         4         5 
    ##  26.48313  95.84369  74.40497 115.39076  42.87744

``` r
sum(A*E[,1])
```

    ## [1] 107

``` r
sum(A*E[,2])
```

    ## [1] 13

``` r
apply(A*E,2,sum)
```

    ##   1   2   3   4   5   6   7 
    ## 107  13  44  64 189 133  13

``` r
A=apply(N,1,sum)/apply(t(B*t(E)),1,sum)
B=apply(N,2,sum)/apply(A*E,2,sum)
A
```

    ##         1         2         3         4         5 
    ## 1.5481556 1.0746664 1.4515159 0.6326330 0.6996686

``` r
B
```

    ##         1         2         3         4         5         6         7 
    ## 0.4710775 0.2642760 0.8468916 0.7239135 0.4891248 0.7766910 1.6515534

``` r
for(i in 1:1000){
  A=apply(N,1,sum)/apply(t(B*t(E)),1,sum)
  B=apply(N,2,sum)/apply(A*E,2,sum)
}
A
```

    ##         1         2         3         4         5 
    ## 1.5404346 1.0447195 1.4825650 0.6553159 0.6634763

``` r
B
```

    ##         1         2         3         4         5         6         7 
    ## 0.4685515 0.2629769 0.8454435 0.7245310 0.4889697 0.7770553 1.6753750

``` r
E * A%*%t(B)
```

    ##         occupation
    ## religion          1          2          3          4          5          6
    ##        1  2.8870914  0.4050987 10.4188024  4.4643702 12.0516123 10.7730250
    ##        2 11.2586111  0.8242113  9.7157637 12.8678376 28.6068235 29.2249717
    ##        3 20.1450811  0.3898804 12.5342484 12.8899708 28.2722423 28.8008726
    ##        4 11.6678702  1.2063307  6.6483904  9.9707299 18.9053460 22.4055332
    ##        5  4.0413463  0.1744790  1.6827951  4.8070914  6.1639760  9.7955975
    ##         occupation
    ## religion          7
    ##        1  0.0000000
    ##        2 10.5017811
    ##        3  4.9677044
    ##        4  2.1957997
    ##        5  3.3347148

``` r
apply(N,1,sum)
```

    ##   1   2   3   4   5 
    ##  41 103 108  73  30

``` r
apply(E * A%*%t(B),1,sum)
```

    ##   1   2   3   4   5 
    ##  41 103 108  73  30

``` r
apply(N,2,sum)
```

    ##   1   2   3   4   5   6   7 
    ##  50   3  41  45  94 101  21

``` r
apply(E * A%*%t(B),2,sum)
```

    ##   1   2   3   4   5   6   7 
    ##  50   3  41  45  94 101  21

``` r
reg=glm(y~religion+occupation,data=df,family=poisson)
summary(reg)
```

    ## 
    ## Call:
    ## glm(formula = y ~ religion + occupation, family = poisson, data = df)
    ## 
    ## Deviance Residuals: 
    ##     Min       1Q   Median       3Q      Max  
    ## -2.2288  -1.2028  -1.0092  -0.7836   6.0644  
    ## 
    ## Coefficients:
    ##             Estimate Std. Error z value Pr(>|z|)    
    ## (Intercept) -0.32604    0.21325  -1.529 0.126285    
    ## religion2   -0.38832    0.18791  -2.066 0.038783 *  
    ## religion3   -0.03829    0.18585  -0.206 0.836771    
    ## religion4   -0.85470    0.19757  -4.326 1.52e-05 ***
    ## religion5   -0.84233    0.24416  -3.450 0.000561 ***
    ## occupation2 -0.57758    0.59549  -0.970 0.332083    
    ## occupation3  0.59022    0.21349   2.765 0.005699 ** 
    ## occupation4  0.43588    0.20603   2.116 0.034381 *  
    ## occupation5  0.04265    0.17590   0.242 0.808399    
    ## occupation6  0.50587    0.17360   2.914 0.003569 ** 
    ## occupation7  1.27415    0.26298   4.845 1.27e-06 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## (Dispersion parameter for poisson family taken to be 1)
    ## 
    ##     Null deviance: 1295.2  on 562  degrees of freedom
    ## Residual deviance: 1215.0  on 552  degrees of freedom
    ## AIC: 1555.1
    ## 
    ## Number of Fisher Scoring iterations: 6

``` r
yp = predict(reg,type="response")
sum(yp)
```

    ## [1] 355

``` r
sum(df$y)
```

    ## [1] 355

``` r
xtabs(yp~df$religion+df$occupation)
```

    ##            df$occupation
    ## df$religion          1          2          3          4          5
    ##           1  2.8870914  0.4050987 10.4188024  4.4643702 12.0516123
    ##           2 11.2586112  0.8242113  9.7157637 12.8678376 28.6068235
    ##           3 20.1450813  0.3898804 12.5342484 12.8899708 28.2722424
    ##           4 11.6678703  1.2063307  6.6483904  9.9707300 18.9053460
    ##           5  4.0413464  0.1744790  1.6827951  4.8070914  6.1639761
    ##            df$occupation
    ## df$religion          6          7
    ##           1 10.7730250  0.0000000
    ##           2 29.2249717 10.5017811
    ##           3 28.8008726  4.9677044
    ##           4 22.4055332  2.1957997
    ##           5  9.7955975  3.3347148

``` r
E * A%*%t(B)
```

    ##         occupation
    ## religion          1          2          3          4          5          6
    ##        1  2.8870914  0.4050987 10.4188024  4.4643702 12.0516123 10.7730250
    ##        2 11.2586111  0.8242113  9.7157637 12.8678376 28.6068235 29.2249717
    ##        3 20.1450811  0.3898804 12.5342484 12.8899708 28.2722423 28.8008726
    ##        4 11.6678702  1.2063307  6.6483904  9.9707299 18.9053460 22.4055332
    ##        5  4.0413463  0.1744790  1.6827951  4.8070914  6.1639760  9.7955975
    ##         occupation
    ## religion          7
    ##        1  0.0000000
    ##        2 10.5017811
    ##        3  4.9677044
    ##        4  2.1957997
    ##        5  3.3347148

``` r
a=exp(coefficients(reg)[1]+c(0,coefficients(reg)[2:5]))
a/a[1]
```

    ##           religion2 religion3 religion4 religion5 
    ## 1.0000000 0.6781979 0.9624329 0.4254098 0.4307072

``` r
A/A[1]
```

    ##         1         2         3         4         5 
    ## 1.0000000 0.6781979 0.9624329 0.4254098 0.4307072

``` r
b=exp(coefficients(reg)[1]+c(0,coefficients(reg)[6:11]))
b/b[1]
```

    ##             occupation2 occupation3 occupation4 occupation5 occupation6 
    ##   1.0000000   0.5612551   1.8043769   1.5463210   1.0435773   1.6584203 
    ## occupation7 
    ##   3.5756477

``` r
B/B[1]
```

    ##         1         2         3         4         5         6         7 
    ## 1.0000000 0.5612551 1.8043770 1.5463210 1.0435773 1.6584203 3.5756478

``` r
yp = predict(reg,type="response")
xtabs(yp~df$religion+df$occupation)
```

    ##            df$occupation
    ## df$religion          1          2          3          4          5
    ##           1  2.8870914  0.4050987 10.4188024  4.4643702 12.0516123
    ##           2 11.2586112  0.8242113  9.7157637 12.8678376 28.6068235
    ##           3 20.1450813  0.3898804 12.5342484 12.8899708 28.2722424
    ##           4 11.6678703  1.2063307  6.6483904  9.9707300 18.9053460
    ##           5  4.0413464  0.1744790  1.6827951  4.8070914  6.1639761
    ##            df$occupation
    ## df$religion          6          7
    ##           1 10.7730250  0.0000000
    ##           2 29.2249717 10.5017811
    ##           3 28.8008726  4.9677044
    ##           4 22.4055332  2.1957997
    ##           5  9.7955975  3.3347148

``` r
E * A%*%t(B)
```

    ##         occupation
    ## religion          1          2          3          4          5          6
    ##        1  2.8870914  0.4050987 10.4188024  4.4643702 12.0516123 10.7730250
    ##        2 11.2586111  0.8242113  9.7157637 12.8678376 28.6068235 29.2249717
    ##        3 20.1450811  0.3898804 12.5342484 12.8899708 28.2722423 28.8008726
    ##        4 11.6678702  1.2063307  6.6483904  9.9707299 18.9053460 22.4055332
    ##        5  4.0413463  0.1744790  1.6827951  4.8070914  6.1639760  9.7955975
    ##         occupation
    ## religion          7
    ##        1  0.0000000
    ##        2 10.5017811
    ##        3  4.9677044
    ##        4  2.1957997
    ##        5  3.3347148

``` r
library(boot)
data(aids)
reg=glm(y~as.factor(delay)+as.factor(time),data=aids)

D=unique(aids$delay)
T=unique(aids$time)
T2=unique(aids$year+(aids$quarter-1/2)/4)
M=matrix(NA,length(T2),length(D))
for(i in 1:length(T2)){
  for(j in 1:length(D)){
    M[i,j]=aids[(aids$time==i)&(aids$delay==D[j]),"y"]}}
for(i in 1:(length(D)-2)){
  M[nrow(M)+1-i,(2+i):length(D)]=NA
}
M
```

    ##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13]
    ##  [1,]    2    6    0    1    1    0    0    1    0     0     0     0     0
    ##  [2,]    2    7    1    1    1    0    0    0    0     0     0     0     0
    ##  [3,]    4    4    0    1    0    2    0    0    0     0     2     1     0
    ##  [4,]    0   10    0    1    1    0    0    0    1     1     1     0     0
    ##  [5,]    6   17    3    1    1    0    0    0    0     0     0     1     0
    ##  [6,]    5   22    1    5    2    1    0    2    1     0     0     0     0
    ##  [7,]    4   23    4    5    2    1    3    0    1     2     0     0     0
    ##  [8,]   11   11    6    1    1    5    0    1    1     1     1     0     0
    ##  [9,]    9   22    6    2    4    3    3    4    7     1     2     0     0
    ## [10,]    2   28    8    8    5    2    2    4    3     0     1     1     0
    ## [11,]    5   26   14    6    9    2    5    5    5     1     2     0     0
    ## [12,]    7   49   17   11    4    7    5    7    3     1     2     2     0
    ## [13,]   13   37   21    9    3    5    7    3    1     3     1     0     0
    ## [14,]   12   53   16   21    2    7    0    7    0     0     0     0     0
    ## [15,]   21   44   29   11    6    4    2    2    1     0     2     0     2
    ## [16,]   17   74   13   13    3    5    3    1    2     2     0     0     0
    ## [17,]   36   58   23   14    7    4    1    2    1     3     0     0     0
    ## [18,]   28   74   23   11    8    3    3    6    2     5     4     1     1
    ## [19,]   31   80   16    9    3    2    8    3    1     4     6     2     1
    ## [20,]   26   99   27    9    8   11    3    4    6     3     5     5     1
    ## [21,]   31   95   35   13   18    4    6    4    4     3     3     2     0
    ## [22,]   36   77   20   26   11    3    8    4    8     7     1     0     0
    ## [23,]   32   92   32   10   12   19   12    4    3     2     0     2     2
    ## [24,]   15   92   14   27   22   21   12    5    3     0     3     3     0
    ## [25,]   34  104   29   31   18    8    6    7    3     8     0     2     1
    ## [26,]   38  101   34   18    9   15    6    1    2     2     2     3     2
    ## [27,]   31  124   47   24   11   15    8    6    5     3     3     4     0
    ## [28,]   32  132   36   10    9    7    6    4    4     5     0     0    NA
    ## [29,]   49  107   51   17   15    8    9    2    1     1     0    NA    NA
    ## [30,]   44  153   41   16   11    6    5    7    2     0    NA    NA    NA
    ## [31,]   41  137   29   33    7   11    6    4    3    NA    NA    NA    NA
    ## [32,]   56  124   39   14   12    7   10    1   NA    NA    NA    NA    NA
    ## [33,]   53  175   35   17   13   11    2   NA   NA    NA    NA    NA    NA
    ## [34,]   63  135   24   23   12    1   NA   NA   NA    NA    NA    NA    NA
    ## [35,]   71  161   48   25    5   NA   NA   NA   NA    NA    NA    NA    NA
    ## [36,]   95  178   39    6   NA   NA   NA   NA   NA    NA    NA    NA    NA
    ## [37,]   76  181   16   NA   NA   NA   NA   NA   NA    NA    NA    NA    NA
    ## [38,]   67   66   NA   NA   NA   NA   NA   NA   NA    NA    NA    NA    NA
    ##       [,14] [,15]
    ##  [1,]     0     1
    ##  [2,]     0     0
    ##  [3,]     0     0
    ##  [4,]     0     0
    ##  [5,]     0     1
    ##  [6,]     0     0
    ##  [7,]     0     2
    ##  [8,]     0     1
    ##  [9,]     0     0
    ## [10,]     0     1
    ## [11,]     0     2
    ## [12,]     1     4
    ## [13,]     0     6
    ## [14,]     1     1
    ## [15,]     2     8
    ## [16,]     3     5
    ## [17,]     3     1
    ## [18,]     1     3
    ## [19,]     2     6
    ## [20,]     1     3
    ## [21,]     3     3
    ## [22,]     2     2
    ## [23,]     0     2
    ## [24,]     1     1
    ## [25,]     2     0
    ## [26,]     0    NA
    ## [27,]    NA    NA
    ## [28,]    NA    NA
    ## [29,]    NA    NA
    ## [30,]    NA    NA
    ## [31,]    NA    NA
    ## [32,]    NA    NA
    ## [33,]    NA    NA
    ## [34,]    NA    NA
    ## [35,]    NA    NA
    ## [36,]    NA    NA
    ## [37,]    NA    NA
    ## [38,]    NA    NA

``` r
aids2=aids
aids2$y[aids2$dud==1]=NA
reg=glm(y~as.factor(delay)+as.factor(time),data=aids2,family=poisson)
summary(reg)
```

    ## 
    ## Call:
    ## glm(formula = y ~ as.factor(delay) + as.factor(time), family = poisson, 
    ##     data = aids2)
    ## 
    ## Deviance Residuals: 
    ##     Min       1Q   Median       3Q      Max  
    ## -3.6079  -0.9572  -0.3329   0.6242   3.8243  
    ## 
    ## Coefficients:
    ##                      Estimate Std. Error z value Pr(>|z|)    
    ## (Intercept)         6.107e-01  2.901e-01   2.105 0.035310 *  
    ## as.factor(delay)2   1.032e+00  3.615e-02  28.535  < 2e-16 ***
    ## as.factor(delay)5  -2.172e-01  4.755e-02  -4.567 4.94e-06 ***
    ## as.factor(delay)8  -7.097e-01  5.701e-02 -12.448  < 2e-16 ***
    ## as.factor(delay)11 -1.212e+00  7.069e-02 -17.138  < 2e-16 ***
    ## as.factor(delay)14 -1.386e+00  7.779e-02 -17.811  < 2e-16 ***
    ## as.factor(delay)17 -1.674e+00  9.076e-02 -18.449  < 2e-16 ***
    ## as.factor(delay)20 -1.941e+00  1.052e-01 -18.461  < 2e-16 ***
    ## as.factor(delay)23 -2.217e+00  1.231e-01 -18.009  < 2e-16 ***
    ## as.factor(delay)26 -2.345e+00  1.354e-01 -17.318  < 2e-16 ***
    ## as.factor(delay)29 -2.620e+00  1.597e-01 -16.405  < 2e-16 ***
    ## as.factor(delay)32 -2.894e+00  1.887e-01 -15.335  < 2e-16 ***
    ## as.factor(delay)35 -3.870e+00  3.181e-01 -12.168  < 2e-16 ***
    ## as.factor(delay)38 -3.002e+00  2.160e-01 -13.899  < 2e-16 ***
    ## as.factor(delay)41 -2.029e+00  1.417e-01 -14.312  < 2e-16 ***
    ## as.factor(time)2   -3.691e-14  4.082e-01   0.000 1.000000    
    ## as.factor(time)3    1.542e-01  3.934e-01   0.392 0.695171    
    ## as.factor(time)4    2.231e-01  3.873e-01   0.576 0.564510    
    ## as.factor(time)5    9.163e-01  3.416e-01   2.683 0.007305 ** 
    ## as.factor(time)6    1.179e+00  3.301e-01   3.570 0.000356 ***
    ## as.factor(time)7    1.365e+00  3.234e-01   4.221 2.43e-05 ***
    ## as.factor(time)8    1.204e+00  3.291e-01   3.658 0.000254 ***
    ## as.factor(time)9    1.658e+00  3.150e-01   5.265 1.40e-07 ***
    ## as.factor(time)10   1.689e+00  3.142e-01   5.377 7.57e-08 ***
    ## as.factor(time)11   1.922e+00  3.091e-01   6.218 5.04e-10 ***
    ## as.factor(time)12   2.303e+00  3.028e-01   7.605 2.84e-14 ***
    ## as.factor(time)13   2.206e+00  3.042e-01   7.254 4.03e-13 ***
    ## as.factor(time)14   2.303e+00  3.028e-01   7.605 2.84e-14 ***
    ## as.factor(time)15   2.413e+00  3.013e-01   8.008 1.17e-15 ***
    ## as.factor(time)16   2.464e+00  3.007e-01   8.193 2.54e-16 ***
    ## as.factor(time)17   2.546e+00  2.998e-01   8.491  < 2e-16 ***
    ## as.factor(time)18   2.668e+00  2.985e-01   8.939  < 2e-16 ***
    ## as.factor(time)19   2.674e+00  2.985e-01   8.960  < 2e-16 ***
    ## as.factor(time)20   2.867e+00  2.968e-01   9.661  < 2e-16 ***
    ## as.factor(time)21   2.927e+00  2.963e-01   9.877  < 2e-16 ***
    ## as.factor(time)22   2.838e+00  2.970e-01   9.556  < 2e-16 ***
    ## as.factor(time)23   2.927e+00  2.963e-01   9.877  < 2e-16 ***
    ## as.factor(time)24   2.904e+00  2.965e-01   9.796  < 2e-16 ***
    ## as.factor(time)25   3.069e+00  2.955e-01  10.387  < 2e-16 ***
    ## as.factor(time)26   2.994e+00  2.960e-01  10.115  < 2e-16 ***
    ## as.factor(time)27   3.185e+00  2.948e-01  10.804  < 2e-16 ***
    ## as.factor(time)28   3.057e+00  2.957e-01  10.338  < 2e-16 ***
    ## as.factor(time)29   3.128e+00  2.953e-01  10.592  < 2e-16 ***
    ## as.factor(time)30   3.235e+00  2.947e-01  10.977  < 2e-16 ***
    ## as.factor(time)31   3.192e+00  2.951e-01  10.815  < 2e-16 ***
    ## as.factor(time)32   3.193e+00  2.953e-01  10.815  < 2e-16 ***
    ## as.factor(time)33   3.375e+00  2.944e-01  11.464  < 2e-16 ***
    ## as.factor(time)34   3.252e+00  2.954e-01  11.008  < 2e-16 ***
    ## as.factor(time)35   3.480e+00  2.944e-01  11.820  < 2e-16 ***
    ## as.factor(time)36   3.604e+00  2.943e-01  12.245  < 2e-16 ***
    ## as.factor(time)37   3.602e+00  2.956e-01  12.187  < 2e-16 ***
    ## as.factor(time)38   3.594e+00  3.148e-01  11.417  < 2e-16 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## (Dispersion parameter for poisson family taken to be 1)
    ## 
    ##     Null deviance: 14184.30  on 464  degrees of freedom
    ## Residual deviance:   716.48  on 413  degrees of freedom
    ##   (105 observations deleted due to missingness)
    ## AIC: 2190.5
    ## 
    ## Number of Fisher Scoring iterations: 5
